name: Verify ESP01 Firmware Build

on:
  push:
    branches:
      - main

jobs:
  verify-build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: ğŸ’  Install PlatformIO
        run: pip install platformio

      - name: âš™ï¸ Patch Firebase API key into configs
        run: |
          sed -i "s|{{FIREBASE_API_KEY}}|${{ secrets.FIREBASE_API_KEY }}|g" include/Configs.hpp

      - name: ğŸ•µï¸ Print certificate content before use (Sanity Check)
        run: |
          echo "ğŸ” Certificate content to be injected:"
          echo "${{ secrets.MQTT_CONNECTION_CERT }}"


      - name: ğŸ” Inject MQTT certificate into MQTTServer.cpp
        run: |
          echo "${{ secrets.MQTT_CONNECTION_CERT }}" > cert.pem

          awk '
            /{{MQTT_CONNECTION_CERT}}/ {
              while ((getline line < "cert.pem") > 0) print line;
              next
            }
            { print }
          ' src/MQTTServer.cpp > src/MQTTServer.cpp.new

          mv src/MQTTServer.cpp.new src/MQTTServer.cpp
          shred -u cert.pem || rm -f cert.pem

      - name: ğŸ” Context check for embedded certificate
        run: |
          echo "ğŸ” Checking 5-line context around BEGIN CERTIFICATE:"
          awk '
            NR > 2 { prev2 = prev1; prev1 = line }
            { line = $0; lines[NR] = $0 }
            /BEGIN CERTIFICATE/ {
              print prev2
              print prev1
              print $0
              getline; print
              getline; print
            }
          ' src/MQTTServer.cpp

          echo ""
          echo "ğŸ” Checking 5-line context around END CERTIFICATE:"
          awk '
            NR > 2 { prev2 = prev1; prev1 = line }
            { line = $0; lines[NR] = $0 }
            /END CERTIFICATE/ {
              print prev2
              print prev1
              print $0
              getline; print
              getline; print
            }
          ' src/MQTTServer.cpp

      - name: ğŸ” Print certificate block SHA256 (masked)
        run: |
          cert_block=$(awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/' src/MQTTServer.cpp)
          echo "$cert_block" | sha256sum | cut -d' ' -f1 > cert_hash.txt
          echo "âœ… Certificate SHA256: $(cat cert_hash.txt)"

      - name: ğŸ“„ Print full MQTTServer.cpp after cert injection
        run: |
          echo "ğŸ“¦ MQTTServer.cpp content after replacement:"
          cat src/MQTTServer.cpp


      - name: âš¡ï¸ Build esp01_1m using mqtt environments
        run: |
          platformio run -e esp01_1m_using_mqtt

      - name: âš¡ï¸ Build esp01_1m using firebase environments
        run: |
          platformio run -e esp01_1m_using_firebase

      - name: âš¡ï¸ Build esp d1 mini using mqtt environments
        run: |
          platformio run -e d1_mini_using_mqtt


      - name: âš¡ï¸ Build esp d1 mini using firebase environments
        run: |
          platformio run -e d1_mini_using_firebase

      - name: ğŸ“‚ Check firmware bin files
        run: |
          for env in esp01_1m_using_firebase esp01_1m_using_mqtt d1_mini_using_firebase d1_mini_using_mqtt; do
            BIN_FILE=".pio/build/$env/firmware.bin"
            if [ ! -f "$BIN_FILE" ]; then
              echo "âŒ Missing firmware binary for $env"
              exit 1
            else
              echo "âœ… Found: $BIN_FILE"
            fi
          done
