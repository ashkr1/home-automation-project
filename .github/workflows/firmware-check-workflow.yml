name: Verify ESP01 Firmware Build

on:
  push:
    branches:
      - main

jobs:
  verify-build:
    runs-on: ubuntu-latest

    steps:
      - name: üìÖ Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: üí† Install PlatformIO
        run: pip install platformio

      - name: ‚öôÔ∏è Patch Firebase API key into configs
        run: |
          sed -i "s|{{FIREBASE_API_KEY}}|${{ secrets.FIREBASE_API_KEY }}|g" include/Configs.hpp
          
      - name: üîê Patch MQTT cert into code
        run: |
          # Save cert as temporary file
          echo "${{ secrets.MQTT_CONNECTION_CERT }}" > cert.pem

          # Create a new file with cert embedded
          awk '
            /{{MQTT_CONNECTION_CERT}}/ {
              while ((getline line < "cert.pem") > 0) {
                print line
              }
              next
            }
            { print }
          ' src/MQTTServer.cpp > src/MQTTServer.cpp.new

          mv src/MQTTServer.cpp.new src/MQTTServer.cpp

          # Delete temporary cert
          shred -u cert.pem || rm -f cert.pem

      - name: ‚ö°Ô∏è Build all environments
        run: |
          platformio run -e esp01_1m_using_firebase
          platformio run -e esp01_1m_using_mqtt
          platformio run -e d1_mini_using_firebase
          platformio run -e d1_mini_using_mqtt

      - name: üìÇ Check firmware bin files
        run: |
          for env in esp01_1m_using_firebase esp01_1m_using_mqtt d1_mini_using_firebase d1_mini_using_mqtt; do
            BIN_FILE=".pio/build/$env/firmware.bin"
            if [ ! -f "$BIN_FILE" ]; then
              echo "‚ùå Missing firmware binary for $env"
              exit 1
            else
              echo "‚úÖ Found: $BIN_FILE"
            fi
          done
