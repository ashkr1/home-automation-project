name: Verify ESP01 Firmware Build

on:
  push:
    branches:
      - main

jobs:
  verify-build:
    runs-on: ubuntu-latest

    steps:
      - name: 📅 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: 💠 Install PlatformIO
        run: pip install platformio

      - name: ⚙️ Patch Firebase API key into configs
        run: |
          sed -i "s|{{FIREBASE_API_KEY}}|${{ secrets.FIREBASE_API_KEY }}|g" include/Configs.hpp
          sed -i "s|{{MQTT_CONNECTION_CERT}}|${{ secrets.MQTT_CONNECTION_CERT }}|g" src/MQTTServer.cpp

      - name: ⚡️ Build all environments
        run: |
          platformio run -e esp01_1m_using_firebase
          platformio run -e esp01_1m_using_mqtt
          platformio run -e d1_mini_using_firebase
          platformio run -e d1_mini_using_mqtt

      - name: 📂 Check firmware bin files
        run: |
          for env in esp01_1m_using_firebase esp01_1m_using_mqtt d1_mini_using_firebase d1_mini_using_mqtt; do
            BIN_FILE=".pio/build/$env/firmware.bin"
            if [ ! -f "$BIN_FILE" ]; then
              echo "❌ Missing firmware binary for $env"
              exit 1
            else
              echo "✅ Found: $BIN_FILE"
            fi
          done
