name: Auto Build & Release ESP01 Firmware

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§® Calculate next version based on lines changed
        id: version
        run: |
          latest=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $latest"
          parts=(${latest//./ })
          major=${parts[0]#v}
          minor=${parts[1]:-0}
          patch=${parts[2]:-0}

          if git rev-parse "$latest" >/dev/null 2>&1; then
            diffstat=$(git diff "$latest"..HEAD --shortstat | awk '{print $1 + $3}')
          else
            diffstat=$(git diff HEAD --shortstat | awk '{print $1 + $3}')
          fi

          if [ "$diffstat" -gt 300 ]; then
            major=$((major+1))
            minor=0
            patch=0
          elif [ "$diffstat" -gt 100 ]; then
            minor=$((minor+1))
            patch=0
          else
            patch=$((patch+1))
          fi

          next="v$major.$minor.$patch"
          echo "âœ… Next version: $next"
          echo "version=$next" >> $GITHUB_OUTPUT

      - name: ğŸ“ Patch version into source
        run: |
          version=${{ steps.version.outputs.version }}
          sed -i "s/v{{VERSION}}/$version/g" platformio.ini || true
          sed -i "s/v{{VERSION}}/$version/g" include/Configs.hpp || true

      - name: ğŸ” Patch Firebase API key into configs
        run: |
          sed -i "s|{{FIREBASE_API_KEY}}|${{ secrets.FIREBASE_API_KEY }}|g" include/Configs.hpp
          sed -i "s|{{MQTT_CONNECTION_CERT}}|${{ secrets.MQTT_CONNECTION_CERT }}|g" src/MQTTServer.cpp

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: ğŸ’  Install PlatformIO
        run: pip install platformio

      - name: âš™ï¸ Build firmware
        run: |
          platformio run -e esp01_1m_using_firebase
          cp .pio/build/esp01_1m_using_firebase/firmware.bin esp01_1m_using_firebase-${{ steps.version.outputs.version }}.bin

          platformio run -e esp01_1m_using_mqtt
          cp .pio/build/esp01_1m_using_mqtt/firmware.bin esp01_1m_using_mqtt-${{ steps.version.outputs.version }}.bin

          platformio run -e d1_mini_using_firebase
          cp .pio/build/d1_mini_using_firebase/firmware.bin d1_mini_using_firebase-${{ steps.version.outputs.version }}.bin

          platformio run -e d1_mini_using_mqtt
          cp .pio/build/d1_mini_using_mqtt/firmware.bin d1_mini_using_mqtt-${{ steps.version.outputs.version }}.bin

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Firmware ${{ steps.version.outputs.version }}
          files: |
            esp01_1m_using_firebase-${{ steps.version.outputs.version }}.bin
            esp01_1m_using_mqtt-${{ steps.version.outputs.version }}.bin
            d1_mini_using_firebase-${{ steps.version.outputs.version }}.bin
            d1_mini_using_mqtt-${{ steps.version.outputs.version }}.bin
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
